version: 2.1
orbs:
  orb-tools: circleci/orb-tools@12.3
  tacotruck: {}

filters: &filters
  tags:
    only: /.*/

release-filters: &release-filters
  branches:
    ignore: /.*/
  tags:
    only: /^v[0-9]+\.[0-9]+\.[0-9]+$/

jobs:
  command-test:
    executor: tacotruck/default
    parameters:
      api_key:
        type: env_var_name
        default: TESTFIESTA_API_KEY
    steps:
      - checkout
      - tacotruck/install:
          version: "latest"
      - run:
          name: Create sample test results
          command: |
            mkdir -p ./test-results
            cat > ./test-results/junit.xml \<< 'EOF'
            <?xml version="1.0" encoding="UTF-8"?>
            <testsuites name="Sample Test Suite" tests="3" failures="1" errors="0" time="0.5">
              <testsuite name="ExampleTests" tests="3" failures="1" errors="0" time="0.5">
                <testcase name="test_success" classname="ExampleTests" time="0.1"/>
                <testcase name="test_failure" classname="ExampleTests" time="0.2">
                  <failure message="Expected true but got false">AssertionError: Expected true but got false</failure>
                </testcase>
                <testcase name="test_another_success" classname="ExampleTests" time="0.2"/>
              </testsuite>
            </testsuites>
            EOF
      - tacotruck/submit:
          provider: "testfiesta"
          base_url: "https://staging.api.testfiesta.com"
          results_path: "./test-results/junit.xml"
          project_key: "PRJ_1"
          api_key: <<parameters.api_key>>
          handle: "acmecorp"
          run_name: "CircleCI Test Run"
workflows:
  test-deploy:
    jobs:
      - command-test:
          filters: *filters
      - orb-tools/pack:
          filters: *release-filters
      - orb-tools/publish:
          orb_name: testfiesta/tacotruck
          vcs_type: gh
          pub_type: dev
          requires:
            - orb-tools/pack
            - command-test
          context: <publishing-context>
          filters: *release-filters
